{% extends 'tracker/base.html' %}

{% block content %}

<!-- Metrics Row -->
<div class="row text-center mb-4">
    <div class="col-md-4">
        <div class="card p-3">
            <div class="metric-label">Income</div>
            <div class="metric-value text-success">£{{ income|floatformat:2 }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3">
            <div class="metric-label">Expenses</div>
            <div class="metric-value text-danger">£{{ expenses|floatformat:2 }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3">
            <div class="metric-label">Balance</div>
            <div class="metric-value text-primary">£{{ balance|floatformat:2 }}</div>
        </div>
    </div>
</div>

<!-- Add Transaction Form -->
<div class="card mb-4">
    <div class="card-header bg-white fw-bold">➕ ADD NEW TRANSACTION</div>
    <div class="card-body">
        <form method="POST">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input type="date" name="date" class="form-control" required value="{% now 'Y-m-d' %}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select" id="typeSelect" onchange="updateCategories()">
                        <option value="Expense">Expense</option>
                        <option value="Income">Income</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select name="category" class="form-select" id="catSelect">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Amount (£)</label>
                    <input type="number" step="0.01" name="amount" class="form-control" required>
                    <div class="form-check mt-2" id="grossCheckDiv" style="display:none;">
                        <input class="form-check-input" type="checkbox" name="is_gross" id="grossCheck">
                        <label class="form-check-label" for="grossCheck">
                            Convert Gross Salary -> Net
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">✅ Add Transaction</button>
            </div>
        </form>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card p-3">
            <div id="cashFlowChart"></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3">
            <div id="expensePieChart"></div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card">
    <div class="card-header bg-white fw-bold">History</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr>
                        <td>{{ t.date }}</td>
                        <td>
                            <span class="badge {% if t.type == 'Income' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ t.type }}
                            </span>
                        </td>
                        <td>{{ t.category }}</td>
                        <td>£{{ t.amount|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'delete_transaction' t.id %}" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Are you sure?')">❌</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No transactions yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Category Logic
    const cats = {
        'Income': ["Salary", "Bonus", "Investment", "Other"],
        'Expense': ["Rent", "Council Tax", "Bills", "Transport", "Groceries", "Entertainment", "Shopping", "Other"]
    };

    function updateCategories() {
        const type = document.getElementById('typeSelect').value;
        const catSelect = document.getElementById('catSelect');
        const grossDiv = document.getElementById('grossCheckDiv');

        catSelect.innerHTML = '';
        cats[type].forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            catSelect.appendChild(opt);
        });

        if (type === 'Income') {
            grossDiv.style.display = 'block';
        } else {
            grossDiv.style.display = 'none';
        }
    }

    // Initialize
    updateCategories();

    // Plotly Charts
    const cashFlowJSON = {{ cash_flow_json|default: "{}" | safe }};
    const expensePieJSON = {{ expense_pie_json|default: "{}" | safe }};

    if (Object.keys(cashFlowJSON).length !== 0) {
        Plotly.newPlot('cashFlowChart', cashFlowJSON.data, cashFlowJSON.layout);
    }
    if (Object.keys(expensePieJSON).length !== 0) {
        Plotly.newPlot('expensePieChart', expensePieJSON.data, expensePieJSON.layout);
    }
</script>

{% endblock %}