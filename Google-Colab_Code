# @title ğŸ‡¬ğŸ‡§ LONDON WEALTH TRACKER (Fixed: 'time' Error Resolved)
import os
import time
import subprocess
import re

# 1. CLEANUP
print("ğŸ§¹ Cleaning up old processes...")
os.system("pkill -f streamlit")
os.system("pkill -f cloudflared")
os.system("rm -rf .streamlit app.py cloudflared-linux-amd64 tunnel.log")

# 2. INSTALLATION
print("â¬‡ï¸ Installing dependencies...")
os.system("pip install -q streamlit pandas plotly")
os.system("wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64")
os.system("chmod +x cloudflared-linux-amd64")

# 3. CONFIG (Light Mode)
os.makedirs(".streamlit", exist_ok=True)
with open(".streamlit/config.toml", "w") as f:
    f.write("""
[theme]
base="light"
primaryColor="#F63366"
backgroundColor="#FFFFFF"
secondaryBackgroundColor="#F0F2F6"
textColor="#000000"
font="sans serif"
""")

# 4. APP CODE (With 'import time' fix)
app_code = """
import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np
from datetime import date
import time  # <--- FIXED: Added missing import

st.set_page_config(page_title="London Wealth Tracker", layout="wide")

# --- CSS: FORCE BLACK TEXT ---
st.markdown(\"\"\"
    <style>
    html, body, p, label, h1, h2, h3, li, span, div, .stMarkdown {color: #000000 !important;}
    .stTextInput input, .stNumberInput input, .stDateInput input, .stSelectbox div[data-baseweb="select"] {
        color: #000000 !important; background-color: #FFFFFF !important; border: 1px solid #ccc !important;
    }
    .streamlit-expanderHeader {color: #000000 !important; font-weight: bold;}
    div[data-baseweb="select"] > div {color: #000000 !important;}
    </style>
\"\"\", unsafe_allow_html=True)

# --- SESSION STATE ---
if 'transactions' not in st.session_state:
    st.session_state.transactions = []

# --- UK TAX CALCULATOR ---
def calculate_net_from_gross(gross):
    pa = 12570
    if gross > 100000: pa = max(0, pa - (gross - 100000) / 2)
    taxable = max(0, gross - pa)
    tax = 0
    if taxable > 125140: 
        tax += (taxable - 125140) * 0.45 + (125140 - 37700) * 0.40 + 37700 * 0.20
    elif taxable > 37700: 
        tax += (taxable - 37700) * 0.40 + 37700 * 0.20
    else: 
        tax += taxable * 0.20
    ni = 0
    if gross > 12570: ni += (min(gross, 50270) - 12570) * 0.08
    if gross > 50270: ni += (gross - 50270) * 0.02
    return (gross - tax - ni) / 12

# --- APP LAYOUT ---
st.title("ğŸ‡¬ğŸ‡§ London Wealth Tracker")

with st.expander("â• ADD NEW TRANSACTION (Click to Expand)", expanded=True):
    c1, c2, c3, c4 = st.columns(4)
    with c1:
        d = st.date_input("Date", date.today())
        t = st.selectbox("Type", ["Expense", "Income"])
    with c2:
        cats = ["Salary", "Bonus", "Investment", "Other"] if t == "Income" else ["Rent", "Council Tax", "Bills", "Transport", "Groceries", "Entertainment", "Shopping", "Other"]
        cat = st.selectbox("Category", cats)
    with c3:
        amt = 0.0
        if t == "Income":
            method = st.radio("Input Method", ["Net Amount", "Gross Salary -> Net"], horizontal=True)
            val = st.number_input("Amount (Â£)", step=100.0)
            if method == "Gross Salary -> Net" and val > 0:
                amt = calculate_net_from_gross(val)
                st.caption(f"Calculated Net: Â£{amt:,.2f}")
            else:
                amt = val
        else:
            amt = st.number_input("Expense Cost (Â£)", step=10.0)
    with c4:
        st.write("##")
        if st.button("âœ… Add Transaction", use_container_width=True):
            if amt > 0:
                tx_id = len(st.session_state.transactions) + 1
                st.session_state.transactions.append({
                    "id": tx_id, 
                    "Date": d, 
                    "Type": t, 
                    "Category": cat, 
                    "Amount": amt
                })
                st.success("Added successfully!")
                time.sleep(0.5) # This will work now
                st.rerun()
            else:
                st.error("Amount must be > 0")

st.divider()

if st.session_state.transactions:
    df = pd.DataFrame(st.session_state.transactions)
    df["Date"] = pd.to_datetime(df["Date"])
    
    inc = df[df["Type"]=="Income"]["Amount"].sum()
    exp = df[df["Type"]=="Expense"]["Amount"].sum()
    bal = inc - exp
    
    k1, k2, k3 = st.columns(3)
    k1.metric("Total Income", f"Â£{inc:,.2f}")
    k2.metric("Total Expenses", f"Â£{exp:,.2f}")
    k3.metric("Current Balance", f"Â£{bal:,.2f}", delta="Savings" if bal > 0 else "Debt")
    
    g1, g2 = st.columns([2, 1])
    df['Month'] = df['Date'].dt.to_period('M').astype(str)
    
    with g1:
        st.subheader("Cash Flow")
        fig = px.bar(df.groupby(['Month', 'Type'])['Amount'].sum().reset_index(), 
                     x='Month', y='Amount', color='Type', barmode='group',
                     color_discrete_map={"Income": "#00CC96", "Expense": "#EF553B"})
        st.plotly_chart(fig, use_container_width=True)
        
    with g2:
        st.subheader("Expenses")
        if exp > 0:
            fig_pie = px.pie(df[df["Type"] == "Expense"], values='Amount', names='Category', hole=0.4)
            st.plotly_chart(fig_pie, use_container_width=True)
    
    if bal > 0:
        st.divider()
        st.subheader("ğŸš€ Future Wealth Projection")
        c_inv1, c_inv2 = st.columns([1, 3])
        with c_inv1:
            rate = st.slider("Interest Rate (%)", 1, 15, 5)
            years = st.slider("Years", 1, 30, 10)
        with c_inv2:
            r = rate / 100 / 12
            months = np.arange(1, years * 12 + 1)
            avg_monthly_add = bal / max(1, df['Month'].nunique())
            fv = [bal * (1 + r)**i + avg_monthly_add * (((1 + r)**i - 1) / r) for i in months]
            st.metric(f"Total Value in {years} Years", f"Â£{fv[-1]:,.2f}")
            st.plotly_chart(px.line(x=months, y=fv, labels={'x': 'Months', 'y': 'Total Value (Â£)'}), use_container_width=True)
    
    st.divider()
    
    c_hist, c_del = st.columns([2, 1])
    with c_hist:
        st.subheader("ğŸ“‹ Transaction History")
        st.dataframe(df.sort_values("Date", ascending=False).drop(columns=["id"]), use_container_width=True)
    with c_del:
        st.subheader("ğŸ—‘ï¸ Delete Transactions")
        options = {f"{row['Date'].strftime('%Y-%m-%d')} | {row['Category']} | Â£{row['Amount']}": i for i, row in df.iterrows()}
        selected_labels = st.multiselect("Select to Delete:", list(options.keys()))
        if st.button("âŒ Delete Selected"):
            if selected_labels:
                indices = [options[l] for l in selected_labels]
                for i in sorted(indices, reverse=True): del st.session_state.transactions[i]
                st.success("Deleted!")
                time.sleep(0.5)
                st.rerun()

else:
    st.info("ğŸ‘‹ Welcome! Please add your first Income or Expense above.")
"""
with open("app.py", "w") as f: f.write(app_code)

# 5. RUN
print("ğŸš€ Launching...")
with open("tunnel.log", "w") as f: f.write("")
subprocess.Popen(["streamlit", "run", "app.py", "--server.headless", "true"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
subprocess.Popen(["./cloudflared-linux-amd64", "tunnel", "--url", "http://localhost:8501"], stdout=subprocess.DEVNULL, stderr=open("tunnel.log", "w"))

print("â³ Waiting for link...")
for i in range(20):
    time.sleep(1)
    try:
        with open("tunnel.log", "r") as f:
            content = f.read()
            match = re.search(r'https://[a-zA-Z0-9-]+\.trycloudflare\.com', content)
            if match:
                print("\n" + "="*50)
                print(f"âœ… YOUR LINK: {match.group(0)}")
                print("="*50 + "\n")
                break
    except: pass
else:
    print("âŒ Link not found yet. Wait a bit more or re-run.")

while True: time.sleep(10)
