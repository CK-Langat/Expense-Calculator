# @title ğŸ‡¬ğŸ‡§ LONDON WEALTH TRACKER (Final Stable Version)
import os
import time
import subprocess
import re
import sys

# 1. TEMÄ°ZLÄ°K (Eski iÅŸlemleri Ã¶ldÃ¼r)
print("ğŸ§¹ Cleaning up background processes...")
os.system("pkill -9 -f streamlit")
os.system("pkill -9 -f cloudflared")
os.system("rm -rf .streamlit app.py cloudflared-linux-amd64 tunnel.log")

# 2. KURULUM
print("â¬‡ï¸ Installing dependencies...")
# Sessiz modda kurulum
subprocess.check_call([sys.executable, "-m", "pip", "install", "-q", "streamlit", "pandas", "plotly"])

if not os.path.exists("cloudflared-linux-amd64"):
    os.system("wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64")
    os.system("chmod +x cloudflared-linux-amd64")

# 3. GÃ–RÃœNÃœM AYARLARI (Light Mode Zorlama)
os.makedirs(".streamlit", exist_ok=True)
with open(".streamlit/config.toml", "w") as f:
    f.write("""
[theme]
base="light"
primaryColor="#F63366"
backgroundColor="#FFFFFF"
secondaryBackgroundColor="#F0F2F6"
textColor="#000000"
font="sans serif"
[server]
headless = true
""")

# 4. UYGULAMA KODU (Time ModÃ¼lÃ¼ Dahil)
app_code = """
import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np
from datetime import date
import time  # <--- CRITICAL IMPORT ADDED

st.set_page_config(page_title="London Wealth Tracker", layout="wide")

# CSS: Force Black Text
st.markdown(\"\"\"
    <style>
    html, body, p, label, h1, h2, h3, li, span, div, .stMarkdown {color: #000000 !important;}
    .stTextInput input, .stNumberInput input, .stDateInput input, .stSelectbox div[data-baseweb="select"] {
        color: #000000 !important; background-color: #FFFFFF !important; border: 1px solid #ccc !important;
    }
    .streamlit-expanderHeader {color: #000000 !important; font-weight: bold;}
    div[data-baseweb="select"] > div {color: #000000 !important;}
    </style>
\"\"\", unsafe_allow_html=True)

if 'transactions' not in st.session_state:
    st.session_state.transactions = []

def calculate_net_from_gross(gross):
    pa = 12570
    if gross > 100000: pa = max(0, pa - (gross - 100000) / 2)
    taxable = max(0, gross - pa)
    tax = 0
    if taxable > 125140: tax += (taxable - 125140)*0.45 + (125140 - 37700)*0.40 + 37700*0.20
    elif taxable > 37700: tax += (taxable - 37700)*0.40 + 37700*0.20
    else: tax += taxable * 0.20
    ni = 0
    if gross > 12570: ni += (min(gross, 50270)-12570)*0.08
    if gross > 50270: ni += (gross - 50270)*0.02
    return (gross - tax - ni) / 12

st.title("ğŸ‡¬ğŸ‡§ London Wealth Tracker")

with st.expander("â• ADD NEW TRANSACTION (Click to Expand)", expanded=True):
    c1, c2, c3, c4 = st.columns(4)
    with c1:
        d = st.date_input("Date", date.today())
        t = st.selectbox("Type", ["Expense", "Income"])
    with c2:
        cats = ["Salary", "Bonus", "Investment", "Other"] if t == "Income" else ["Rent", "Council Tax", "Bills", "Transport", "Groceries", "Entertainment", "Shopping", "Other"]
        cat = st.selectbox("Category", cats)
    with c3:
        amt = 0.0
        if t == "Income":
            m = st.radio("Input Method", ["Net Amount", "Gross Salary -> Net"], horizontal=True)
            v = st.number_input("Amount (Â£)", step=100.0)
            if m == "Gross Salary -> Net" and v > 0:
                amt = calculate_net_from_gross(v)
                st.caption(f"Calculated Net: Â£{amt:,.2f}")
            else:
                amt = v
        else:
            amt = st.number_input("Expense (Â£)", step=10.0)
    with c4:
        st.write("##")
        if st.button("âœ… Add Transaction", use_container_width=True):
            if amt > 0:
                st.session_state.transactions.append({"Date": d, "Type": t, "Category": cat, "Amount": amt})
                st.success("Added!")
                time.sleep(0.5)
                st.rerun()
            else:
                st.error("Amount > 0")

st.divider()

if st.session_state.transactions:
    df = pd.DataFrame(st.session_state.transactions)
    df["Date"] = pd.to_datetime(df["Date"])
    inc = df[df["Type"]=="Income"]["Amount"].sum()
    exp = df[df["Type"]=="Expense"]["Amount"].sum()
    bal = inc - exp
    
    k1, k2, k3 = st.columns(3)
    k1.metric("Income", f"Â£{inc:,.2f}"); k2.metric("Expenses", f"Â£{exp:,.2f}"); k3.metric("Balance", f"Â£{bal:,.2f}")
    
    g1, g2 = st.columns([2, 1])
    df['M'] = df['Date'].dt.to_period('M').astype(str)
    with g1:
        st.subheader("Cash Flow")
        st.plotly_chart(px.bar(df.groupby(['M', 'Type'])['Amount'].sum().reset_index(), x='M', y='Amount', color='Type', barmode='group'), use_container_width=True)
    with g2:
        st.subheader("Expenses")
        if exp > 0: st.plotly_chart(px.pie(df[df["Type"] == "Expense"], values='Amount', names='Category'), use_container_width=True)

    if bal > 0:
        st.divider(); st.subheader("ğŸš€ Projection")
        r = st.slider("Interest %", 1, 15, 5)/100/12; y = st.slider("Years", 1, 30, 10)
        m = np.arange(1, y*12+1)
        fv = [bal*(1+r)**i + (bal/max(1,df['M'].nunique()))*(((1+r)**i - 1)/r) for i in m]
        st.metric(f"Total in {y} Years", f"Â£{fv[-1]:,.2f}")
        st.plotly_chart(px.line(x=m, y=fv), use_container_width=True)

    # DELETE SECTION
    st.divider()
    c_hist, c_del = st.columns([2, 1])
    with c_hist:
        st.subheader("History")
        st.dataframe(df.sort_values("Date", ascending=False), use_container_width=True)
    with c_del:
        st.subheader("Delete")
        opts = {f"{r['Date'].strftime('%Y-%m-%d')} | {r['Category']} | Â£{r['Amount']}": i for i, r in df.iterrows()}
        sels = st.multiselect("Select:", list(opts.keys()))
        if st.button("âŒ Delete Selected") and sels:
            for i in sorted([opts[s] for s in sels], reverse=True): del st.session_state.transactions[i]
            st.success("Deleted!"); time.sleep(0.5); st.rerun()
else:
    st.info("Add a transaction to start.")
"""
with open("app.py", "w") as f: f.write(app_code)

# 5. BAÅLATMA VE LÄ°NK YAKALAMA
print("ğŸš€ Launching App...")
with open("tunnel.log", "w") as f: f.write("")

# Arka planda baÅŸlat
subprocess.Popen(["streamlit", "run", "app.py"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
subprocess.Popen(["./cloudflared-linux-amd64", "tunnel", "--url", "http://localhost:8501"], stdout=subprocess.DEVNULL, stderr=open("tunnel.log", "w"))

print("â³ Waiting for link generation...")
found = False
for i in range(30):  # 30 saniye bekle
    time.sleep(1)
    try:
        with open("tunnel.log", "r") as f:
            content = f.read()
            match = re.search(r'https://[a-zA-Z0-9-]+\.trycloudflare\.com', content)
            if match:
                url = match.group(0)
                print("\n" + "="*50)
                print(f"âœ… YOUR NEW LINK: {url}")
                print("="*50 + "\n")
                print("âš ï¸ NOT: Eski linki kapat, SADECE bu yeni linke tÄ±kla!")
                found = True
                break
    except: pass

if not found:
    print("âŒ Link oluÅŸmadÄ±. LÃ¼tfen 'Runtime > Disconnect and Delete Runtime' yapÄ±p tekrar dene.")
else:
    # HÃ¼creyi canlÄ± tut
    while True:
        time.sleep(10)
